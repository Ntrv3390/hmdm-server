<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hmdm.plugins.worktime.persistence.postgres.dao.mapper.PostgresWorkTimeMapper">

    <resultMap id="globalPolicyResult"
               type="com.hmdm.plugins.worktime.model.WorkTimePolicy">
        <id property="id" column="id"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="startDateTime" column="start_datetime"/>
        <result property="endDateTime" column="end_datetime"/>
        <result property="daysOfWeek" column="days_of_week"/>
        <result property="allowedAppsDuringWork" column="allowed_apps_during_work"/>
        <result property="allowedAppsOutsideWork" column="allowed_apps_outside_work"/>
        <result property="enabled" column="enabled"/>
        <result property="customerId" column="customer_id"/>
    </resultMap>

    <select id="getGlobalPolicy" resultMap="globalPolicyResult">
        SELECT *
        FROM worktime_global_policy
        WHERE customer_id = #{customerId}
        LIMIT 1
    </select>

    <insert id="insertGlobalPolicy">
        INSERT INTO worktime_global_policy (
            id,
            start_time,
            end_time,
            days_of_week,
            allowed_apps_during_work,
            allowed_apps_outside_work,
            enabled,
            customer_id
        ) VALUES (
            1,
            #{startTime},
            #{endTime},
            #{daysOfWeek},
            #{allowedAppsDuringWork},
            #{allowedAppsOutsideWork},
            #{enabled},
            #{customerId}
        )
    </insert>

    <update id="updateGlobalPolicy">
        UPDATE worktime_global_policy
        SET
            start_time = #{startTime},
            end_time = #{endTime},
            days_of_week = #{daysOfWeek},
            allowed_apps_during_work = #{allowedAppsDuringWork},
            allowed_apps_outside_work = #{allowedAppsOutsideWork},
            enabled = #{enabled}
        WHERE id = 1
          AND customer_id = #{customerId}
    </update>

    <!-- ========================================================= -->
    <!-- User overrides mapping & queries                         -->
    <!-- ========================================================= -->

    <resultMap id="userOverrideResult"
               type="com.hmdm.plugins.worktime.model.WorkTimeUserOverride">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="startDateTime" column="start_datetime"/>
        <result property="endDateTime" column="end_datetime"/>
        <result property="daysOfWeek" column="days_of_week"/>
        <result property="allowedAppsDuringWork" column="allowed_apps_during_work"/>
        <result property="allowedAppsOutsideWork" column="allowed_apps_outside_work"/>
        <result property="enabled" column="enabled"/>
        <result property="customerId" column="customer_id"/>
        <result property="priority" column="priority"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="getUserOverrides" resultMap="userOverrideResult">
        SELECT uo.*, users.name as user_name
        FROM worktime_user_override uo
        LEFT JOIN users ON users.id = uo.user_id
        WHERE uo.customer_id = #{customerId}
        ORDER BY uo.priority DESC NULLS LAST, uo.id
    </select>

    <select id="getUserOverride" resultMap="userOverrideResult">
        SELECT uo.*, users.name as user_name
        FROM worktime_user_override uo
        LEFT JOIN users ON users.id = uo.user_id
        WHERE uo.customer_id = #{customerId} AND uo.user_id = #{userId}
        LIMIT 1
    </select>

    <insert id="insertUserOverride" parameterType="com.hmdm.plugins.worktime.model.WorkTimeUserOverride" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO worktime_user_override (
            user_id,
            start_time,
            end_time,
            start_datetime,
            end_datetime,
            days_of_week,
            allowed_apps_during_work,
            allowed_apps_outside_work,
            enabled,
            priority,
            customer_id,
            created_at,
            updated_at
        ) VALUES (
            #{userId},
            #{startTime},
            #{endTime},
            #{startDateTime},
            #{endDateTime},
            #{daysOfWeek},
            #{allowedAppsDuringWork},
            #{allowedAppsOutsideWork},
            #{enabled},
            #{priority},
            #{customerId},
            now(),
            now()
        )
    </insert>

    <update id="updateUserOverride" parameterType="com.hmdm.plugins.worktime.model.WorkTimeUserOverride">
        UPDATE worktime_user_override
        SET
            start_time = #{startTime},
            end_time = #{endTime},
            start_datetime = #{startDateTime},
            end_datetime = #{endDateTime},
            days_of_week = #{daysOfWeek},
            allowed_apps_during_work = #{allowedAppsDuringWork},
            allowed_apps_outside_work = #{allowedAppsOutsideWork},
            enabled = #{enabled},
            priority = #{priority},
            updated_at = now()
        WHERE customer_id = #{customerId} AND user_id = #{userId}
    </update>

    <delete id="deleteUserOverride">
        DELETE FROM worktime_user_override
        WHERE customer_id = #{customerId} AND user_id = #{userId}
    </delete>

    <select id="getAllUserOverrides" resultMap="userOverrideResult">
        SELECT uo.*, users.name as user_name
        FROM worktime_user_override uo
        LEFT JOIN users ON users.id = uo.user_id
        ORDER BY uo.customer_id, uo.priority DESC NULLS LAST, uo.id
    </select>

</mapper>

